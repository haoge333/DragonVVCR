<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龙之谷菜鸡排行榜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .form-control {
            margin-bottom: 15px;
        }
        .complaint-card {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        .stats-card {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">龙之谷菜鸡排行榜</h1>

        <!-- 登录/注册表单 -->
        <div id="authSection">
            <ul class="nav nav-tabs" id="authTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab" aria-controls="login" aria-selected="true">登录</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button" role="tab" aria-controls="register" aria-selected="false">注册</button>
                </li>
            </ul>
            <div class="tab-content" id="authTabContent">
                <div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">游戏名</label>
                            <input type="text" class="form-control" id="loginUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">登录</button>
                    </form>
                </div>
                <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerUsername" class="form-label">游戏名</label>
                            <input type="text" class="form-control" id="registerUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerRegion" class="form-label">大区</label>
                            <input type="text" class="form-control" id="registerRegion" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerServer" class="form-label">服务器</label>
                            <input type="text" class="form-control" id="registerServer" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerGameId" class="form-label">游戏ID</label>
                            <input type="text" class="form-control" id="registerGameId" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">注册</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 吐槽系统主界面 -->
        <div id="complaintSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>欢迎, <span id="username"></span></h2>
                <button id="logoutBtn" class="btn btn-outline-secondary">退出登录</button>
            </div>

            <ul class="nav nav-tabs" id="mainTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="complain-tab" data-bs-toggle="tab" data-bs-target="#complain" type="button" role="tab" aria-controls="complain" aria-selected="true">我要吐槽</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="myComplaints-tab" data-bs-toggle="tab" data-bs-target="#myComplaints" type="button" role="tab" aria-controls="myComplaints" aria-selected="false">我的吐槽</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab" aria-controls="stats" aria-selected="false">吐槽统计</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab" aria-controls="search" aria-selected="false">搜索吐槽</button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- 我要吐槽 -->
                <div class="tab-pane fade show active" id="complain" role="tabpanel" aria-labelledby="complain-tab">
                    <form id="complaintForm">
                        <div class="mb-3">
                            <label for="targetPlayerId" class="form-label">被吐槽玩家游戏ID</label>
                            <input type="text" class="form-control" id="targetPlayerId" required>
                        </div>
                        <div class="mb-3">
                            <label for="dungeonName" class="form-label">副本名称</label>
                            <input type="text" class="form-control" id="dungeonName" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">吐槽内容</label>
                            <textarea class="form-control" id="description" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">提交吐槽</button>
                    </form>
                </div>

                <!-- 我的吐槽 -->
                <div class="tab-pane fade" id="myComplaints" role="tabpanel" aria-labelledby="myComplaints-tab">
                    <div id="myComplaintsList"></div>
                </div>

                <!-- 吐槽统计 -->
                <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-card">
                                <h5>最常被吐槽的玩家</h5>
                                <div id="mostComplainedPlayers"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <h5>最常被吐槽的副本</h5>
                                <div id="mostComplainedDungeons"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 搜索吐槽 -->
                <div class="tab-pane fade" id="search" role="tabpanel" aria-labelledby="search-tab">
                    <div class="mb-3">
                        <label for="searchType" class="form-label">搜索类型</label>
                        <select class="form-select" id="searchType">
                            <option value="player">被吐槽玩家</option>
                            <option value="dungeon">副本名称</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="searchKeyword" class="form-label">关键词</label>
                        <input type="text" class="form-control" id="searchKeyword">
                    </div>
                    <button id="searchBtn" class="btn btn-primary mb-3">搜索</button>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">系统提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentUser = null;
        let authToken = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查本地存储中是否有token
            authToken = localStorage.getItem('authToken');
            if (authToken) {
                // 验证token是否有效
                fetch('http://localhost:8088/TestProject/api/users/profile', {
                    headers: {
                        'Authorization': authToken
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Token无效');
                    }
                })
                .then(user => {
                    currentUser = user;
                    showComplaintSection();
                })
                .catch(error => {
                    localStorage.removeItem('authToken');
                    showToast('登录已过期，请重新登录', 'warning');
                });
            }

            // 绑定表单提交事件
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('complaintForm').addEventListener('submit', handleComplaintSubmit);

            // 绑定按钮点击事件
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('searchBtn').addEventListener('click', handleSearch);

            // 绑定标签页切换事件
            document.getElementById('myComplaints-tab').addEventListener('shown.bs.tab', loadMyComplaints);
            document.getElementById('stats-tab').addEventListener('shown.bs.tab', loadStats);
        });

        // 处理登录
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            fetch('http://localhost:8088/TestProject/api/users/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    showToast('登录成功', 'success');
                    showComplaintSection();
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                showToast('登录失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 处理注册
        function handleRegister(event) {
            event.preventDefault();

            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const region = document.getElementById('registerRegion').value;
            const server = document.getElementById('registerServer').value;
            const gameId = document.getElementById('registerGameId').value;

            fetch('http://localhost:8088/TestProject/api/users/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password,
                    region: region,
                    server: server,
                    gameId: gameId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('注册成功，请登录', 'success');
                    // 切换到登录标签页
                    document.getElementById('login-tab').click();
                } else {
                    showToast(data.message, 'danger');
                }
            })
            .catch(error => {
                showToast('注册失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 处理吐槽提交
        function handleComplaintSubmit(event) {
            event.preventDefault();

            const targetPlayerId = document.getElementById('targetPlayerId').value;
            const dungeonName = document.getElementById('dungeonName').value;
            const description = document.getElementById('description').value;

            fetch('http://localhost:8088/TestProject/api/complaints', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': authToken
                },
                body: JSON.stringify({
                    user: {
                        id: currentUser.id
                    },
                    targetPlayerId: targetPlayerId,
                    dungeonName: dungeonName,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    showToast('吐槽提交成功', 'success');
                    // 清空表单
                    document.getElementById('complaintForm').reset();
                } else {
                    showToast('吐槽提交失败', 'danger');
                }
            })
            .catch(error => {
                showToast('吐槽提交失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 处理退出登录
        function handleLogout() {
            fetch('http://localhost:8088/TestProject/api/users/logout', {
                method: 'POST',
                headers: {
                    'Authorization': authToken
                }
            })
            .then(response => {
                if (response.ok) {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    currentUser = null;
                    showToast('退出登录成功', 'success');
                    showAuthSection();
                } else {
                    showToast('退出登录失败', 'danger');
                }
            })
            .catch(error => {
                showToast('退出登录失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 加载我的吐槽
        function loadMyComplaints() {
            fetch(`http://localhost:8088/TestProject/api/complaints/user/${currentUser.id}`, {
                headers: {
                    'Authorization': authToken
                }
            })
            .then(response => response.json())
            .then(complaints => {
                const container = document.getElementById('myComplaintsList');
                container.innerHTML = '';

                if (complaints.length === 0) {
                    container.innerHTML = '<p>您还没有发表任何吐槽</p>';
                    return;
                }

                complaints.forEach(complaint => {
                    const card = document.createElement('div');
                    card.className = 'complaint-card';
                    card.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <h5>被吐槽玩家: ${complaint.targetPlayerId}</h5>
                            <small>${new Date(complaint.createdTime).toLocaleString()}</small>
                        </div>
                        <p class="mt-2"><strong>副本:</strong> ${complaint.dungeonName}</p>
                        <p><strong>描述:</strong> ${complaint.description}</p>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteComplaint(${complaint.id})">删除</button>
                    `;
                    container.appendChild(card);
                });
            })
            .catch(error => {
                showToast('加载吐槽失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 删除吐槽
        function deleteComplaint(id) {
            if (!confirm('确定要删除这条吐槽吗？')) {
                return;
            }

            fetch(`http://localhost:8088/TestProject/api/complaints/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': authToken
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('删除成功', 'success');
                    // 重新加载吐槽列表
                    loadMyComplaints();
                } else {
                    showToast('删除失败', 'danger');
                }
            })
            .catch(error => {
                showToast('删除失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 加载统计数据
        function loadStats() {
            // 加载最常被吐槽的玩家
            fetch('http://localhost:8088/TestProject/api/complaints/stats/most-complained-players')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('mostComplainedPlayers');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<p>暂无数据</p>';
                    return;
                }

                data.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `${index + 1}. ${item[0]} - ${item[1]} 次吐槽`;
                    container.appendChild(div);
                });
            })
            .catch(error => {
                showToast('加载统计数据失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });

            // 加载最常被吐槽的副本
            fetch('http://localhost:8088/TestProject/api/complaints/stats/most-complained-dungeons')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('mostComplainedDungeons');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<p>暂无数据</p>';
                    return;
                }

                data.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `${index + 1}. ${item[0]} - ${item[1]} 次吐槽`;
                    container.appendChild(div);
                });
            })
            .catch(error => {
                showToast('加载统计数据失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 处理搜索
        function handleSearch() {
            const searchType = document.getElementById('searchType').value;
            const keyword = document.getElementById('searchKeyword').value.trim();

            if (!keyword) {
                showToast('请输入搜索关键词', 'warning');
                return;
            }

            let url = '';
            if (searchType === 'player') {
                url = `http://localhost:8088/TestProject/api/complaints/player/${encodeURIComponent(keyword)}`;
            } else {
                url = `http://localhost:8088/TestProject/api/complaints/dungeon/${encodeURIComponent(keyword)}`;
            }

            fetch(url)
            .then(response => response.json())
            .then(complaints => {
                const container = document.getElementById('searchResults');
                container.innerHTML = '';

                if (complaints.length === 0) {
                    container.innerHTML = '<p>没有找到相关吐槽</p>';
                    return;
                }

                complaints.forEach(complaint => {
                    const card = document.createElement('div');
                    card.className = 'complaint-card';
                    card.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <h5>被吐槽玩家: ${complaint.targetPlayerId}</h5>
                            <small>${new Date(complaint.createdTime).toLocaleString()}</small>
                        </div>
                        <p class="mt-2"><strong>副本:</strong> ${complaint.dungeonName}</p>
                        <p><strong>描述:</strong> ${complaint.description}</p>
                    `;
                    container.appendChild(card);
                });
            })
            .catch(error => {
                showToast('搜索失败，请检查网络连接', 'danger');
                console.error('Error:', error);
            });
        }

        // 显示吐槽系统主界面
        function showComplaintSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('complaintSection').style.display = 'block';
            document.getElementById('username').textContent = currentUser.username;
        }

        // 显示登录/注册界面
        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('complaintSection').style.display = 'none';
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toastElement = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            // 设置消息内容
            toastMessage.textContent = message;

            // 设置样式类
            toastElement.className = `toast bg-${type === 'success' ? 'success' : type === 'danger' ? 'danger' : type === 'warning' ? 'warning' : 'info'} text-white`;

            // 显示toast
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    </script>
</body>
</html>
